#! /bin/sh
#

#Je n'ai pas réglé le problème des images dont on a changé le nom ...
#C'est un problème dans un module
# Make distribution tgz packages
#on execute le script dans le dossier wims

#ligne à changer
# 3.63a = r256
<<<<<<< .mine
version=3.63b2
=======
# 3.63b = r468
# 3.63c = r677
# 3.63d = r720
# 3.64 = r798
version=3.64
>>>>>>> .r630

#on mettra la version intermédiaire dans $target
export whome=$HOME
export target=$whome/transfer

#on nettoie $target
mkdir -p $target
rm -Rf $target/*


echo export svn in  $target/wims
svn export . $target/wims

#on met le numéro de version où il faut
ed $target/wims/README.template <<@
 ,s/WIMS_VERSION/$version/
w
@

mv $target/wims/README.template $target/wims/README

ed $target/wims/src/configure.in <<@
 ,s/WIMS_VERSION/$version/
w
@
#j'enlève le fichier configure.in de la distribution car il ne sert pas
#sert à générer par autoconf configure qui lui reste
#il reste bien sûr dans le svn. Sinon, il va y avoir une confusion avec la version 
#svn ; sinon faire un template comme pour le README ?

cd $target/wims/src ; autoconf configure.in > configure ; chmod a+x configure ;
rm $target/wims/src/configure.in

echo enlève les fichiers générés par autoconf
rm -Rf *.cache *.log 2>/dev/null

echo on enlève le mkdistsvn de la nouvelle version
rm $target/wims/mkdistsvn

####provisoirement on enlève les fichiers pt-br
rm -Rf $target/wims/public_html/html/href.pt-br $target/wims/public_html/html/mirror.phtml.pt-br $target/wims/public_html/html/msg.phtml.pt-br \
 $target/wims/public_html/html/msg/module_error.msg.pt-br $target/wims/public_html/html/msg/user_error.phtml.pt-br $target/wims/public_html/html/msg/warn_rawmath.phtml.pt-br\
 $target/wims/public_html/html/msg/warn_rawmatrix.phtml.pt-br $target/wims/public_html/html/name.phtml.pt-br $target/wims/public_html/html/robot.phtml.pt-br $target/wims/public_html/msg/module_error.msg.pt-br $target/wims/public_html/msg/user_error.phtml.pt-br $target/wims/public_html/msg/warn_rawmath.phtml.pt-br $target/wims/public_html/msg/warn_rawmatrix.phtml.pt-br \
 $target/wims/public_html/scripts/docu/pt-br $target/wims/public_html/scripts/oef/pt-br



echo on enlève les fichiers parasites
find $target/wims -name .DS_Store -exec rm '{}' \;

echo on crée le fichier version 
echo $version >$target/wims/version
# problème avec forall, je l'ai enlevé du svn
mkdir -m 777 $target/dist/tmp/forall

echo Archiving WIMS package...
cd $target/wims ; tar -czf ../wims-$version.tgz --exclude=CVS .

######FIN DU FICHIER, le reste est l'ancien script que Xiao nous a donné

#je ne comprends pas trop si la suite est utile. Il me semble que non
# export whome=/home/wdev
# export target=/mobile/transfer/wims
# version=`$whome/public_html/wims.cgi version`
# distmod=`sort dist-modules | uniq | grep .`
# categories=public_html/bases/sys/categories.phtml
# 
#inutile ?
# rm -Rf ../src/*.cache ../src/*.log 2>/dev/null
# rm -Rf $target/dist
# for i in dist dist/public_html dist/public_html/{modules,bases} dist/public_html/modules/{devel,data}
# do
#   mkdir -m 755 $target/$i
# done  
# 
### On n'a pas la main sur cela
# echo "!! Automatically generated by mkdist according to collect/categories/*.
# !! Do not edit.
# <dl>" >$whome/$categories
# for t in E H U Lang tool; do
#  case $t in
#   E) tt=E1-E6;;
#   H) tt=H1-H6;;
#   U) tt=U1-U4;;
#   *) tt=$t;;
#  esac
#  echo "
# <dt>$tt<dd>" >>$whome/$categories
#  cat $whome/collect/categories/$t | grep . >>$whome/$categories
# done
# echo "
# </dl>" >>$whome/$categories
#

### Pour l'instant tout cela est créé dans svn 
# mkdir $target/dist/tmp
# mkdir -m 700 $target/dist/tmp/log
# mkdir -m 777 $target/dist/tmp/forall
# mkdir $target/dist/tmp/sessions
# mkdir $target/dist/download
# mkdir -p $target/dist/lib
# mkdir -p $target/dist/other/bin
# cp $whome/download/wimsget $target/dist/download
# 
# for i in sessions s2 log log/{forums,modules,classes,account,referer} public_html/{msg,bin,bases/site,bases/site/lists,bases/site/pop}
# do
#   mkdir -m 700 $target/dist/$i
# done
# cp -dpR $whome/log/classes/[1-9]??? $target/dist/log/classes
# cp -dpR $whome/log/classes/.build-index $target/dist/log/classes
# cp -dpR $whome/log/forums/{1001,template,.build-index,README} $target/dist/log/forums
# cp $whome/public_html/bases/site/pop/dic $target/dist/public_html/bases/site/pop
# cp $whome/public_html/bases/site/popular $target/dist/public_html/bases/site
# cp $whome/public_html/bases/site/lists/popular $target/dist/public_html/bases/site/lists
# 
# #chmod a+x $target/dist/sessions
# echo "deny from all" >$target/dist/log/classes/.htaccess
# 
# for i in bin src lib compile
# do
#   cp -dpR $whome/$i $target/dist
# done
# cp $whome/other/bin/flydraw $target/dist/other/bin
# cp $whome/README* $whome/HEADER* $whome/dist/update.sh $target
# ed $target/README <<@
# ,s/WIMS_VERSION/$version/
# w
# @
# cp $target/README $target/dist 2>/dev/null
# 
# cp -pd $whome/public_html/* $target/dist/public_html 2>/dev/null
# 
# for i in bin msg html gifs mathfonts scripts java themes
# do
#   cp -dpR $whome/public_html/$i $target/dist/public_html
# done
# rm -fR $target/dist/public_html/themes/local/* 2>/dev/null
# 
# # In order to skip site
# for i in dic doc factbook fortune sheet sys units wikipedia .htaccess
# do
#   cp -dpR $whome/public_html/bases/$i $target/dist/public_html/bases
# done
# for i in $target/dist/public_html/bases/doc/[0-9]*
# do
#  rm -fr $i/.code
#  echo '*' >$i/.code 2>/dev/null
#  chmod og-r $i/.code
# done
# for i in $target/dist/public_html/bases/doc/20?
# do
#  rm -fr $i/.code
#  echo 'dddd' >$i/.code 2>/dev/null
#  chmod a-w $i/.code
# done
# 
# for i in home classes help template adm Remarks
# do
#   cp -dpR $whome/public_html/modules/$i $target/dist/public_html/modules
# done
# cp $whome/src/Changelog $target/Changelog.system
# mkdir $target/dist/public_html/modules/local
# 
# cd $target/dist
# cd public_html/modules
# rm -fR adm/priv adm/unice adm/local
# cd ..
# rm -fR bases/doc/{.index,open.site} \
# 	{.htaccess,wims.cgi,wims} bin/{coq,imps}\
# 	bases/doc/?????[0-9]* 2>/dev/null
# cd ..
# rm -f bin/takelog src/configure.scan, src/config.{h,log,status}\
# 	src/{.menu.mu,defaults.conf} >/dev/null
# 
# cp -dpR $whome/dist/* $target/dist
# 
# for m in $distmod
# do
#  pr=`dirname $m`
#  mkdir -p $target/dist/public_html/modules/$pr
#  cp -dpR $whome/public_html/modules/$m* $target/dist/public_html/modules/$pr
# done
# 
# cd $target/dist/public_html/modules/H3/algebra/spuzzle
# rm -fR {photos,pieces}/*
# cp $whome/public_html/modules/H3/algebra/spuzzle/photos/{beach,road}.gif photos
# for m in H3/algebra/spuzzle U2/algebra/qpuzzle
# do
#  cd $target/dist/public_html/modules/$m
#  rm -fR pieces/* 2>/dev/null
# done
# find $target/dist -name .wimshome -exec rm '{}' \;
# 
# cd $target/dist/src
# make distclean
# cd ..
# echo Archiving WIMS package...
# tar -czf ../wims-$version.tgz .
# echo Archiving WIMS contrib package...
# cd $whome
# tar -czf $target/wims-contrib-$version.tgz public_html/modules/contrib
# 
# cd $target

# 
 echo $version >$target/version
# chmod a-x $target/update.sh
# cd $target
# stat -t *.tgz *.sh [A-Z]* version | cut -d ' ' -f 1,2 >filesizes
# 
