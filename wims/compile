#! /bin/sh

if [ "$(id -ru)" = 0 ]; then
 cat <<@
You are trying to compile WIMS as 'root'. You should not do that !
Please compile as 'wims'.
@
 exit 1
fi

option=$1

##########################################################################
cat <<@
Welcome to the compilation of WIMS (WWW Interactive Multipurpose Server)

@
if [ ! "$option" ] ; then option=no ; fi ;
if [ "$option" = "--build-chroot" ] ; then
  echo "compile with option $option"
fi

cd `dirname $0`

if [ "$option" = "--build-chroot" ] ; then
  if [ -d chroot ] ; then  
    mkdir -p chroot/tmp
    mkdir -p chroot/tmp/sessions
    touch chroot/tmp/sessions/.chroot
  else
   cat <<@
   You must first get and install the chroot directory. See the README

@
   exit 1
  fi 
fi

cd src

if [ -f ../.wims_maintainer_mode ]; then
  touch configure.in ;
  if (autoconf); then :; else
    echo "[maintainer mode] Please install autoconf first."
    exit 1
  fi
  autoheader
fi
./configure || exit
make clean || exit
make all || exit

if [ -f ../.wims_maintainer_mode ]; then
### use convert, identify
  make maintainer || exit
### all the maintainers should have Apache ant - java compilation
  if (ant -version); then :; else
    echo "[maintainer mode] Please install Apache ant first."
    exit 1
  fi
  if (convert -version) || (identify -version); then :; else
    echo "[maintainer mode] Please install convert and identify first."
    exit 1
  fi
  cd Misc ; make maintainer || exit
  cd ..
fi
cd ..

if [ -f log/wims.conf ]; then :; else
  cat <<@ 

You can configure some parameters which allow the manager site
to make more configuration from the web interface.

Please write the IP address of the wims webmaster ? [127.0.0.1]
@
  read ans1
  if [ -z $ans1 ]; then :; else
    echo "manager_site=$ans1" >> log/wims.conf
    chmod 600 log/wims.conf
  fi
  cat <<@ 

Please write the email address of the wims webmaster: ? []
@
  read ans2
  if [ -z $ans2 ]; then
     if [ -z $ans1 ]; then :; else echo "site_manager=" >> log/wims.conf; fi
  else
     if [ -z $ans1 ]; then echo "manager_site=127.0.0.1" >> log/wims.conf ; fi
     echo "site_manager=$ans2" >> log/wims.conf
     chmod 600 log/wims.conf
  fi
fi
if [ -f log/.wimspass ]; then :; else
  cat <<@ 
  
Please give the password for the wims webmaster
You can change it in the file log/.wimspass
Webmaster password: ? []
@
  read ans3
  if [ -z $ans3 ]; then :; else
    echo "$ans3" > log/.wimspass
    chmod 600 log/.wimspass
  fi
fi
if [ $option = "--build-chroot" ] ; then
  script=wrapuid ;
else
 script=setwrapexec ;
fi
cat <<@

Please run './bin/$script' (and './bin/apache-config' for the first installation) as root 
(e.g. using sudo) to finish WIMS setup.

See README about installation of help and teaching modules.

@

exit