good=!rows2lines $(replygood$i)
!if $(replytype$i) iswordof flashcard
 !set option1=!line 1 of $oef_fill_option
 !set option2=!line 2 of $oef_fill_option
 good=!line 1 to 2 of $good
!endif
menulist=!line 2 to -1 of $good
menulist=!translate internal $\
$ to ; in $menulist
good=!line 1 of $good
replyGood$i=!item $good of $menulist
replyGood$i=!replace internal \\( by \( in $(replyGood$i)
!if $(replytype$i) iswordof flashcard
 replygood1=
 !for x in $menulist
   replygood1$i=!append item <div $option2>$x</div> to $(replygood1$i)
 !next
 replygood$i=$good\
$(replygood1$i)
 replyGood$i=!makelist <div $option2>x</div> for x in $(replyGood$i)
 replygood$i=!replace internal ; by &#59; in $(replygood$i)
!endif
!if $wims_read_parm=nocompare
 !exit
!endif

!if $(replyGood$i)=$empty
 Test=bad $i
 !exit
!endif

!reset menupos
!if $(replytype$i) iswordof mark flashcard
  menupos=$(reply$i)
  !if  $(replytype$i) iswordof flashcard
    click=$(menupos[2;])
    menupos=$(menupos[1;])
    reply$i=$menupos
  !endif
  m_reply$i=!item $menupos of $menulist
  reply_$i=$(m_reply$i)
  !if  $(replytype$i) iswordof flashcard
    m_reply$i=$(m_reply$i)\
$click
    reply$i=$(reply$i)
    reply_$i= !makelist <div $option2>x</div> for x in $(reply_$i)
    reply_$i=!items2words $(reply_$i)
  !endif
!else
 reply$i=!replace internal \\( by \( in $(reply$i)
 m_reply$i=$(reply$i)
 !if $(replytype$i) notwordof checkbox menu
  !if &#39; isin $menulist
   reply$i=!replace internal ' by &#39; in $(reply$i)
  !endif
  !if &#44; isin $menulist
   reply$i=!replace internal , by &#44; in $(reply$i)
  !endif
 !endif
 cnti_ = !itemcnt $(reply$i)
 !for u_ = 1 to $cnti_ 
  ri_ =!item $u_ of $(reply$i)
  mp_=!positionof item $ri_ in $menulist
  menupos=!append item $mp_ to $menupos
 !next u_
!endif
menupos=!nonempty items $menupos
!if $menupos=$empty
 test=NaN
 !exit
!endif

poscnt1=!itemcnt $menupos
menupos=!listintersect $menupos and $good
poscnt2=!itemcnt $menupos
poscnt3=!itemcnt $good
!if split iswordof $(replyoption$i) or partialscore iswordof (replyoption$i)
 !if $poscnt1=$poscnt2 and $poscnt1=$poscnt3
  diareply$i=good
  !advance freegot
 !else
  !if eqweight iswordof $(replyoption$i)
   diaratio=$[2*$poscnt2 - $poscnt1]
  !else
   diaratio=$[3*$poscnt2 - 2*$poscnt1]
  !endif
  !if $diaratio > 0
   diareply$i=good
   partialgood$i=yes
   freegot=$[$freegot+ max(0,$diaratio/max($poscnt3,1))]
  !else
   diareply$i=bad
  !endif
 !endif
!else
 !if $poscnt1=$poscnt2 and $poscnt1=$poscnt3
  diareply$i=good
  !advance freegot
 !else
  diareply$i=bad
 !endif
!endif