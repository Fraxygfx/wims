!set n=$counter
<link rel="stylesheet" href="$htmldir/jqmath.css">
<script src="$jsdir/jqmath.js"></script> 
!set mathviewpanel=sqrt,log
<table>
    <tr>
    <td id="math_out" style="font-size:180%;">
    </td>
    </tr>
    <tr>
    <td>
	<textarea class="schaervoorde_input" id="JSMathView" rows="2" cols="30"></textarea>
	<textarea class="schaervoorde_input" id="dbg" rows="2" cols="30"></textarea>
    </td>
    </tr>
    <tr>
    <td>
	<table class="demospecial" id="show_it">
	    <tr>
	    <td onclick="javascript:button('^');">^</td>
	    <td onclick="javascript:button('/');">/</td>
	    <td onclick="javascript:button('*');">*</td>
	    <td onclick="javascript:button('+');">+</td>
	    <td onclick="javascript:button('-');">&minus;</td>
	    <td onclick="javascript:button('\\pi');">&pi;</td>
	    <td colspan="2">$module_title</td>
	    </tr>
	    <tr>
	    <td onclick="javascript:button('&radic;');">&radic;</td>
	    <td onclick="javascript:button('sin()');">sin</td>
	    <td onclick="javascript:button('cos()');">cos</td>
	    <td onclick="javascript:button('tan()');">tan</td>
	    <td onclick="javascript:button('log()');">log</td>
	    <td colspan="3" id="clear_it" style="background-color:orange;">clear</td>
	    </tr>
	!if sqrt isin $mathviewpanel
	    <tr>
	    <td onclick="javascript:button('sqrt[3]()');"><sup>3</sup>&radic;()</td>
	    <td onclick="javascript:button('sqrt[4]()');"><sup>4</sup>&radic;()</td>
	    <td onclick="javascript:button('sqrt[5]()');"><sup>5</sup>&radic;()</td>
	    <td onclick="javascript:button('sqrt[6]()');"><sup>6</sup>&radic;()</td>
	    <td onclick="javascript:button('sqrt[7]()');"><sup>7</sup>&radic;()</td>
	    <td onclick="javascript:button('sqrt[8]()');"><sup>8</sup>&radic;()</td>
	    <td onclick="javascript:button('sqrt[9]()');"><sup>9</sup>&radic;()</td>
	    <td onclick="javascript:button('sqrt[10]()');"><sup>10</sup>&radic;()</td>
	    </tr>
	!endif
	!if log isin $mathviewpanel
	    <tr>
	    <td onclick="javascript:button('log[3]()');"><sup>3</sup>log()</td>
	    <td onclick="javascript:button('log[4]()');"><sup>4</sup>log()</td>
	    <td onclick="javascript:button('log[5]()');"><sup>5</sup>log()</td>
	    <td onclick="javascript:button('log[6]()');"><sup>6</sup>log()</td>
	    <td onclick="javascript:button('log[7]()');"><sup>7</sup>log()</td>
	    <td onclick="javascript:button('log[8]()');"><sup>8</sup>log()</td>
	    <td onclick="javascript:button('log[9]()');"><sup>9</sup>log()</td>
	    <td onclick="javascript:button('log[10]()');"><sup>10</sup>log()</td>
	    </tr>
	!endif
	</table>
    </td>
    </tr>
</table>

<script type="text/javascript">
 function button(string){document.getElementById("JSMathView").value += string;return;}
    
 function displayroot(t){
  var power;var sqrt;var begin;var end;var mod;var tot;var wait;var got;var chr;var t1;var t2;var t3;var t4;var test;var org;
  t2=t.indexOf("](");if(t2==-1){setAlarm(r11);t="error";return t;}
  org=t;t=t.replace(/sqrt\(/g,"SQRT(");
  t=t.replace(/log\[/g,"LOG~");t=t.replace(/sqrt\[/g,"@[");test=t.replace(/[a-z]\[/g,"#");
  if(test.indexOf("#")!=-1){setAlarm(r11);t="error"; return t;}
  t2=t.indexOf("[");var trouble=0;
  while(t2 != -1){
    begin=t.indexOf("@");t2=t.indexOf("[");t3=t.indexOf("]");
    if(t2==begin+1 && t3>t2){
     power=t.substring(t2+1,t3);
     if(power.length==0){setAlarm(r16);t="error";return t;}
     if(power<2){setAlarm(r16);t="error";return t;}
     t4="["+power+"]";t=t.replace(t4,'');
     tot=t.length;wait=0;got=0;end=0;
     for(s=begin;s<tot;s++){
      if(end==0){
       chr=t.charAt(s);
       if(chr=="("){wait=wait+1;}
       if(chr==")"){got=got+1;}
       if(got!=0){if(wait==got){end=s;}}
      }
     }
     begin=begin+2;
     sqrt=t.substring(begin,end);
     mod=(power % 2);
     if(sqrt<0 && mod!=1){setAlarm(r16);t="error";return t;}
     t=t.replace("@("+sqrt+")","{^"+power+"&radic;#"+sqrt+"!}");
    }
    else{t=t.replace("]","?");}
    trouble++;if(trouble>100){setAlarm(r20);t="error";return t;}
   }
   t=t.replace(/SQRT\(/g,"&radic;#");
   t=t.replace(/LOG~/g,"log[");
   t=t.replace(/~/g,"[");
   t=t.replace(/\?/g,"]");
   t=t.replace(/@/g,"&radic;");
 return t;
}
function displaylog(t){
    var noemer;var teller;var begin;var end;var tot;var wait;var got;var chr;var t1;var t2;var t3;var t4;
    t2=t.indexOf("](");if(t2==-1){setAlarm(r11);t="error";return t;}
    t=t.replace(/log\(/g,'LOG(');
    t=t.replace(/log/g,"@");
    t2=t.indexOf("[");var trouble=0;
    while(t2 != -1){
	begin=t.indexOf("@");t3=t.indexOf("]");
	if(t2==begin+1 && t3>t2){
	    grondtal=t.substring(t2+1,t3);
	    if(grondtal=="10"){setAlarm(r14);t="error";return t;}
	    if(grondtal=="e" || grondtal=='E'){setAlarm(r15);t="error";return t;}
	    t4="["+grondtal+"]";t=t.replace(t4,'');
	    tot=t.length;wait=0;got=0;end=0;
	    for(s=begin;s<tot;s++){
		if(end==0){
		    chr=t.charAt(s);
		    if(chr=="("){wait=wait+1;}
		    if(chr==")"){got=got+1;}
		    if(got!=0){if(wait==got){end=s;}}
		}
	    }
	    begin=begin+2;teller=t.substring(begin,end);
	    if(grondtal==teller){setAlarm(r17);}
	    t=t.replace("@("+teller+")","{^"+grondtal+"~#"+teller+"!}}");
	}else{t=t.replace("[","%");}
	t2=t.indexOf("[");
	trouble++;if(trouble>100){setAlarm(r20);t="error";return t;}
    }
    t=t.replace(/\%/g,"[");
    t=t.replace(/~/g,"log");
    t=t.replace(/LOG\(/g,"log#");
    t=t.replace(/@/g,"log");
    return t;
}

function find_group(t){
    var left=0;var idx=-1;
    while(t.indexOf('(') != -1 ){
	t=t.replace('(','#');
	left++;
	idx = t.indexOf(')');
	while( idx != -1 ){
	    t=t.replace(')','!');
	    left--;	    
	    if(left == 0){t=t.substring(0,idx+1)+"}"+t.substring(idx+1,t.length);return t;}
	    idx=t.indexOf(')');
	}
    }
    return t;
}

function rewrite(input){
var dbg=document.getElementById('dbg');
    if(input.indexOf("sqrt[") != -1){ input = displayroot(input);}
    if(input.indexOf("log[") != -1){ input = displaylog(input);}
    var math = ["sin","cos","tan","log"];
    var rep_math = ["\\sin","\\cos","\\tan","\\log"];
    var len = input.length;var replaced;
    for(var i=0;i < math.length ; i++){
	replaced = 0;
	while( input.indexOf(math[i])!= -1){
	    input = input.replace(math[i],"@");
	    input = find_group(input);
	    replaced = 1;
	}
	if(replaced == 1 ){
	    input=input.replace(/@/g,"{"+rep_math[i]);
	}
	else
	{
	    input=input.replace(/@/g,rep_math[i]);
	}
    dbg.value="input= "+input; 
    }
    input=input.replace(/#/g,'(');
    input=input.replace(/!/g,')');
    return input;
}
</script>

<script>
"use strict";
var ents_ = { nwarr: '\u2196', swarr: '\u2199' };
var JSMathView = document.getElementById("JSMathView");
var math_out = document.getElementById("math_out");
var show_it = document.getElementById("show_it");
var clear_it = document.getElementById("clear_it");
show_it.addEventListener('click',function(e){doMathSrc(1);},false);
clear_it.addEventListener('click',function(e){JSMathView.value=" ";doMathSrc(1);return;},false);
JSMathView.addEventListener('keyup',function(e){doMathSrc(1);},false);
function doMathSrc(n) {
	var org = JSMathView.value;
	var ms = rewrite(org);
	if(!ms){return;}
	ms = ms.replace(/&([-#.\w]+);|\\([a-z]+)(?: |(?=[^a-z]))/ig,
	 function(s, e, m) {
	  if (m && (M.macros_[m] || M.macro1s_[m]))	return s;	
	  /* e.g. \it or \sc */
	  var t = '&'+(e || m)+';', res = $$('<span>'+t+'</span>').text();
	  return res != t ? res : ents_[e || m] || s;
	}
	);
	var t;
	try { 
	 t = M.sToMathE(ms, true); math_out.removeChild(math_out.childNodes[0]); math_out.appendChild(t);
	} catch(e) { setAlarm(e); }
	JSMathView.value=org;
}
</script>
