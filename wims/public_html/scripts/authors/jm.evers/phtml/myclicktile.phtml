!set id=$wims_nowseconds
!set xn=3
!set yn=3
!set bg_color=#FFFFFF
!set click_colors=["#FF0000","#0000FF","#008000","#FFA500"];
!set line_width=2
!set fill_color=#00FF00
!set stroke_color=#FF0000
!set fill_opacity=0.3
!set stroke_opacity=0.3
!set image_x=[1,1,1,1,1,1,1]
!set image_y=[1,2,3,4,5,6,7]
!set status=waiting
!set xsize=360
!set ysize=360
!set clicktile_image=http://localhost/drum.jpg

<div onmouseover="check_svg_capability()" id="svg_div$id" style="width:$[$xsize+20];height:$[$ysize+20];overflow:auto;">
<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events" id="wims_svg$id" width="$xsize" height="$ysize" viewBox="0 0 $xsize $ysize" >
<g id="svg_transform$id" transform="scale(1)" >
<image preserveAspectRatio="none" xlink:href="$clicktile_image" x="0" y="0" height="100%" width="100%"></image> 
<script type="text/javascript">
var line_width = $line_width;
var stroke_color = "$stroke_color";
var fill_color = "$fill_color";
var stroke_opacity = $stroke_opacity;
var fill_opacity = $fill_opacity;
var id = $id;
var xn = $xn;
var yn = $yn;
var image_x = $image_y;
var image_y = $image_x;
var wims_svg = document.getElementById("wims_svg"+id);
var data = (wims_svg.getAttribute("viewBox")).split(' ');
sizex = data[2] - data[0];
sizey = data[3] - data[1];
var w = sizex / xn;
var h = sizey / yn;
var x,y;
var bg_color = "$bg_color";
var color_num = 1;
var num_proctected_rects = 10; 
var i = 0;
var image_colors = $click_colors
var color_idx = 0;
var found;
var color_length = image_colors.length;
var protected = new Array(); 
Array.prototype.listuniq = function(){ 
 var o = {}, i, l = this.length, r = []; 
 for(i=0; i < l; i += 1){
  o[this[i]] = this[i];
 }
 for(i in o){ 
  r.push(o[i]);
 }
 return r;
} 
var user_click_colors = new Array();
user_click_colors = image_colors.listuniq();
var num_colors = user_click_colors.length;
var protected_idx = 0;
for(var p = 0 ; p < sizey ; p = p+h){
 for(var i = 0 ; i < sizex ; i = i+w){
  var rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
  rect.setAttributeNS(null,"x",i);
  rect.setAttributeNS(null,"y",p);
  rect.setAttributeNS(null,"width",w);
  rect.setAttributeNS(null,"height",h);
  rect.setAttributeNS(null,"stroke-width",line_width);
  rect.setAttributeNS(null,"id","rect"+id);
  found = 0;
  for(var c = 0; c < image_x.length && found == 0 ; c++){
   if(p == w*(image_x[c]-1) && i == h*(image_y[c]-1)){
    found = 1;
   }
  }
  if(found == 1){
   rect.setAttributeNS(null,"fill",image_colors[color_idx]);
   protected[protected_idx] = "rect"+id;protected_idx++;
   if(color_idx > color_length - 1){ color_idx = 0;  } else { color_idx++; }
  }
  else
  {
   rect.setAttributeNS(null,"fill",bg_color);
  }
  rect.setAttributeNS(null,"stroke",stroke_color);
  rect.setAttributeNS(null,"stroke-opacity",stroke_opacity);
  rect.setAttributeNS(null,"fill-opacity",fill_opacity);
  if("waiting" == "$status" ){
   rect.addEventListener("mousedown", function(action){svg_mouse(action.which,this.id)}, false);
  }
  wims_svg.appendChild(rect);id++; 
 }
}
function paint_color(myid){
 for(var p = 0; p< protected.length; p++){
  if( myid == protected[p] ){
   return 0;
  }
 }
 try{
  var obj = document.getElementById(myid);
  obj.setAttributeNS(null,"fill",user_click_colors[color_num]);
 }catch(e){alert(e);}
 return 0;
}
function svg_mouse(button,myid){
 if( button > 1){
  color_num++;
  if( color_num > num_colors - 1){
   color_num = 0;
  }
 }
 paint_color(myid);
 return 0;
}
function read_svg(){
 var reply=new Array();
 var idx = 0;
 var obj;
 var x;
 var y;
 var color;
 var myid;
 for(var p=$id; p < id ;p++){
  myid = "rect"+p;
  if( protected.indexOf(myid) == -1 ){
   obj = document.getElementById(myid);
   color = obj.getAttributeNS(null,"fill");
   if( color != bg_color ){
    x = 1+(obj.getAttributeNS(null,"x"))/w;
    y = 1+(obj.getAttributeNS(null,"y"))/h;
    reply[idx] = color;
    reply[idx+1] = x;
    reply[idx+2] = y+"\n";
    idx = idx+3;
   }
  }
 }
 return reply;
}
</script>

<script type="text/javascript">
//<![CDATA[
var just_once = 0;function check_svg_capability(){if( just_once == 0 ){ if( document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Shape", "1.0") == null ){alert("Your browser does not support SVG \n To enjoy this exercise \nGet Firefox\n http://www.mozilla.org");just_once = 1;}}}
//]]>
</script>
</g>
</svg>
</div>
<input type="button" onclick="javascript:alert(read_svg());" value="test" />