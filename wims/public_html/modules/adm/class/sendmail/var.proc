!read adm/class/classlang names.phtml

!if $error isitemof notsupervisor,noclass,nosupervisormail
    !exit
!endif

!bound job within all,filter,login,select default all
!if $job notwordof login select
  !reset loginlist
!endif

job=!items2words $job
aim=email

!if $msg issametext and $cmd notwordof new renew
  error=empty_msg
!endif

!if $email_exists=0
  error=$error empty_user
!endif

!if $cmd=resume
  !reset list_user list_noemail error
!endif

list_user=
list_noemail=
!default job=all

rac=wimshome/log/classes/$wims_class
wims_superclass=!defof class_superclass in $rac/.def
!default wims_superclass=$wims_class
file=$rac/.userlist

!if select iswordof $job and login iswordof $job
   loginlist_=!listuniq $loginlist,$select_user
!else
  !if login iswordof $job
    loginlist_=$loginlist
  !else
    loginlist_=$select_user
  !endif
!endif
!if $job=all or $loginlist_=$empty
  loginlist_=all
!endif

$(aim)_exists=0

variable=!trim $variable
!set cnt=!recordcnt wimshome/log/classes/$wims_class/.userlist
!!!set list_user=
!!!set list_noemail=

!if filter iswordof $job
   !if $variable!=$empty
     filter_cnt=!linecnt $variable
     !reset filter
     !for v=1 to $filter_cnt
       line=!singlespace $(variable[$v;])
       line =!replace $ $ by , in $line
       filter=!append line $line to $filter
     !next
   !endif
!endif
!if $filter=$empty and $job notwordof select login
   filter=all
!endif
!for lu =1 to $cnt
  TEST=
  us_=!record $lu of $file
  !distribute item $us_ into l_name_,f_name_,login
  !defread wimshome/log/classes/$wims_superclass/.users/$login
  !if $filter=all or $filter=$empty
    !if $loginlist_=all or $login isitemof $loginlist_ or $filter=all
      TEST=1
      !goto OK
    !endif
  !else
    !if ($login isitemof $loginlist_) or $loginlist_=all or ($filter!=all and $filter!=$empty)
     !read adm/class/testfilter $login\
$filter
    TEST=$var_filter_test
  !else
   TEST=0
  !endif
 !endif
:OK
  !if $TEST=1
    aim_=!defof user_$aim in wimshome/log/classes/$wims_superclass/.users/$login
    !if $aim_!=
     list_user=!append line $login,$l_name_,$f_name_,$aim_ to $list_user
     !set $(aim)_exists=1
    !else
     list_noemail=!append line $login,$l_name_,$f_name_, to $list_noemail
    !endif
  !endif
!next lu
!goto end
!endif
!endif

!if $job=login
  !for lu =1 to $cnt
   us_=!record $lu of $file
   !distribute item $us_ into l_name_,f_name_,login
   !if $login isitemof $loginlist
    !defread wimshome/log/classes/$wims_superclass/.users/$login
    aim_=!defof user_$aim in wimshome/log/classes/$wims_superclass/.users/$login
    !if $aim_ !=
     list_user=!append line $login,$l_name_,$f_name_,$ph_ to $list_user
     !set $(aim)_exists=1
    !else
     list_noemail=!append line $login,$l_name_,$f_name_, to $list_noemail
    !endif
   !endif
  !next lu
 !goto end
!endif


:end


!! teacher list

aim_=!defof user_email in wimshome/log/classes/$wims_class/supervisor
list_teacher=supervisor,,,$aim_
 !if $wims_superclass!=$wims_class
  !set other_teachers=!record 0 of wimshome/log/classes/$wims_class/.teacherlist
  !set other_teachers=!column 3 of $other_teachers
  !for ot in $other_teachers
   m_ot=!getdef user_email in wimshome/log/classes/$wims_superclass/.users/$ot
   !if $m_ot !=$empty
    list_teacher=!append line $ot,,,$m_ot to $list_teacher
   !endif
  !next
 !endif
